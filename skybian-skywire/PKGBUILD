# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
# Maintainer: Rudi [KittyCash] <rudi@skycoinmail.com>
projectname=skycoin
pkgname=skybian-skywire
pkgname1=skywire
githuborg=SkycoinProject
pkgdesc="Skybian's skywire installation"
pkgver='autogenerated'
#pkgver='autogenerated'
pkggopath="github.com/${githuborg}/${pkgname1}"
pkgrel=1
#pkgrel=1
arch=('any')
url="https://${pkggopath}"
url1="https://github.com/${githuborg}/skybian"
license=()
makedepends=(git go)
depends=(${makedepends})
provides=('skywire')
source=("git+${url}.git#branch=${BRANCH:-master}"
"git+${url1}.git#branch=${BRANCH:-master}")
sha256sums=('SKIP'
'SKIP')

#tar -czvf skywire-scripts.tar.gz skywire-scripts
#tar -czvf skywire-systemd.tar.gz skywire-systemd
export GOOS=linux
export GOPATH=${srcdir}
export CGO_ENABLED=0

case "$CARCH" in
x86)      export GOARCH="386" GO386="387" ;;
x86_64)   export GOARCH="amd64" ;;
arm*)     export GOARCH="arm" ;;
armel)    export GOARCH="arm" GOARM="5" ;;
armhf)    export GOARCH="arm" GOARM="6" ;;
armv7)    export GOARCH="arm" GOARM="7" ;;
armv8)    export GOARCH="arm64" ;;
aarch64)  export GOARCH="arm64" ;;
mips)     export GOARCH="mips" ;;
mips64)   export GOARCH="mips64" ;;
mips64el) export GOARCH="mips64le" ;;
mipsel)   export GOARCH="mipsle" ;;
*)        return 1 ;;
	esac

pkgver() {
	cd ${srcdir}/${pkgname1}
	local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
	local count=$(git rev-list --count HEAD)
	local commit=$(git rev-parse --short HEAD)
	echo "${date}.${count}_${commit}"
}

prepare() {
	#verify PKGBUILD signature
	#gpg --verify ${srcdir}/PKGBUILD.sig ../PKGBUILD
	# https://wiki.archlinux.org/index.php/Go_package_guidelines
	mkdir -p ${srcdir}/go/src/github.com/${githuborg}/ ${srcdir}/go/bin
	ln -rTsf ${srcdir}/${pkgname1} ${srcdir}/go/src/github.com/${githuborg}/${pkgname1}
	cd ${srcdir}/go/src/github.com/${githuborg}/${pkgname1}/cmd
	git checkout master
	git submodule --quiet update --init --recursive
}

#build() {
#}

package() {
	#create directory trees
	mkdir -p ${pkgdir}/usr/local/skywire/go/src/github.com/SkycoinProject/
	mkdir -p ${pkgdir}/usr/local/skywire/go/bin
	mkdir -p ${pkgdir}/usr/local/bin
	mkdir -p ${pkgdir}/etc/profile.d/
	mkdir -p ${pkgdir}/etc/default/
	mkdir -p ${pkgdir}/etc/update-motd.d/
	mkdir -p ${pkgdir}/etc/systemd/system/
	#install skywire github source
	cp -r ${srcdir}/${pkgname1} ${pkgdir}/usr/local/skywire/go/src/github.com/SkycoinProject/
	#install skybian things
	install -Dm644 ${srcdir}/skybian/static/skybian.conf ${pkgdir}/etc/
	install -Dm755 ${srcdir}/skybian/static/10-skybian-header ${pkgdir}/etc/update-motd.d/
	install -Dm644 ${srcdir}/skybian/static/armbian-motd ${pkgdir}/etc/default/
	install -Dm755 ${srcdir}/skybian/static/skybian-config ${pkgdir}/usr/local/bin/
  install -Dm644 ${srcdir}/skybian/static/armbian-check-first-login.sh ${pkgdir}/etc/profile.d/
  install -Dm644 ${srcdir}/skybian/static/golang-env-settings.sh ${pkgdir}/etc/profile.d/
	#install the system.d services
	install -Dm644 ${srcdir}/${pkgname1}/static/script/upgrade/data/${pkgname1}-manager.service ${pkgdir}/etc/systemd/system/
	install -Dm644 ${srcdir}/${pkgname1}/static/script/upgrade/data/${pkgname1}-node.service ${pkgdir}/etc/systemd/system/
	install -Dm644 ${srcdir}/skybian/static/skybian-config.service ${pkgdir}/etc/systemd/system/
}
